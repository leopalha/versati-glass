generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String         @id @default(uuid())
  email                 String         @unique
  password              String?
  name                  String
  phone                 String?
  cpfCnpj               String?
  street                String?
  number                String?
  complement            String?
  neighborhood          String?
  city                  String?
  state                 String?
  zipCode               String?
  role                  Role           @default(CUSTOMER)
  emailVerified         DateTime?
  phoneVerified         Boolean        @default(false)
  authProvider          AuthProvider   @default(EMAIL)
  googleId              String?        @unique
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  lastLoginAt           DateTime?
  accounts              Account[]
  assignedAppointments  Appointment[]  @relation("AssignedTo")
  appointments          Appointment[]
  assignedConversations Conversation[] @relation("AssignedConversations")
  conversations         Conversation[]
  documents             Document[]
  messages              Message[]
  orders                Order[]
  quotes                Quote[]
  sessions              Session[]
  notifications         Notification[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Product {
  id               String          @id @default(uuid())
  name             String
  slug             String          @unique
  description      String
  shortDescription String?
  category         ProductCategory
  subcategory      String?
  images           String[]
  thumbnail        String?
  priceType        PriceType
  basePrice        Decimal?
  pricePerM2       Decimal?
  priceRangeMin    Decimal?
  priceRangeMax    Decimal?
  colors           String[]
  finishes         String[]
  thicknesses      String[]
  isActive         Boolean         @default(true)
  isFeatured       Boolean         @default(false)
  metaTitle        String?
  metaDescription  String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  orderItems       OrderItem[]
  quoteItems       QuoteItem[]

  @@map("products")
}

model Quote {
  id                  String          @id @default(uuid())
  number              String          @unique
  userId              String
  customerName        String
  customerEmail       String
  customerPhone       String
  serviceStreet       String
  serviceNumber       String
  serviceComplement   String?
  serviceNeighborhood String
  serviceCity         String
  serviceState        String
  serviceZipCode      String
  subtotal            Decimal
  discount            Decimal         @default(0)
  total               Decimal
  status              QuoteStatus     @default(DRAFT)
  validUntil          DateTime
  internalNotes       String?
  customerNotes       String?
  source              QuoteSource
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  sentAt              DateTime?
  viewedAt            DateTime?
  acceptedAt          DateTime?
  selectedSupplierId  String?
  aiConversation      AiConversation?
  appointments        Appointment[]
  conversations       Conversation[]
  documents           Document[]
  orders              Order[]
  items               QuoteItem[]
  selectedSupplier    Supplier?       @relation("SelectedSupplier", fields: [selectedSupplierId], references: [id])
  user                User            @relation(fields: [userId], references: [id])
  supplierQuotes      SupplierQuote[]

  @@map("quotes")
}

model QuoteItem {
  id             String   @id @default(uuid())
  quoteId        String
  productId      String?
  description    String
  specifications String?
  width          Decimal?
  height         Decimal?
  quantity       Int      @default(1)
  color          String?
  finish         String?
  thickness      String?
  glassType      String?
  glassColor     String?
  model          String?
  unitPrice      Decimal
  totalPrice     Decimal
  customerImages String[]
  product        Product? @relation(fields: [productId], references: [id])
  quote          Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_items")
}

model Order {
  id                    String               @id @default(uuid())
  number                String               @unique
  quoteId               String?
  supplierId            String?
  userId                String
  serviceStreet         String
  serviceNumber         String
  serviceComplement     String?
  serviceNeighborhood   String
  serviceCity           String
  serviceState          String
  serviceZipCode        String
  subtotal              Decimal
  discount              Decimal              @default(0)
  installationFee       Decimal              @default(0)
  total                 Decimal
  paymentStatus         PaymentStatus        @default(PENDING)
  paymentMethod         PaymentMethod?
  paidAmount            Decimal              @default(0)
  stripeSessionId       String?
  stripePaymentIntentId String?
  status                OrderStatus          @default(ORCAMENTO_ENVIADO)
  estimatedDelivery     DateTime?
  installedAt           DateTime?
  completedAt           DateTime?
  warrantyUntil         DateTime?
  internalNotes         String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  appointments          Appointment[]
  documents             Document[]
  items                 OrderItem[]
  timeline              OrderTimelineEntry[]
  payments              Payment[]
  quote                 Quote?               @relation(fields: [quoteId], references: [id])
  supplier              Supplier?            @relation(fields: [supplierId], references: [id])
  user                  User                 @relation(fields: [userId], references: [id])

  @@map("orders")
}

// Payments for flexible payment methods
model Payment {
  id            String          @id @default(uuid())
  orderId       String
  method        PaymentMethod
  amount        Decimal
  installments  Int             @default(1)
  status        PaymentStatus   @default(PENDING)
  externalId    String?         // Stripe payment intent, PIX code, etc.
  paidAt        DateTime?
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model OrderItem {
  id             String          @id @default(uuid())
  orderId        String
  productId      String?
  description    String
  specifications String?
  width          Decimal?
  height         Decimal?
  quantity       Int             @default(1)
  color          String?
  finish         String?
  thickness      String?
  unitPrice      Decimal
  totalPrice     Decimal
  status         OrderItemStatus @default(PENDING)
  order          Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product?        @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model OrderTimelineEntry {
  id          String   @id @default(uuid())
  orderId     String
  status      String
  description String
  createdBy   String
  createdAt   DateTime @default(now())
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_timeline")
}

model Appointment {
  id                  String            @id @default(uuid())
  userId              String
  orderId             String?
  quoteId             String?
  type                AppointmentType
  scheduledDate       DateTime
  scheduledTime       String
  estimatedDuration   Int
  addressStreet       String
  addressNumber       String
  addressComplement   String?
  addressNeighborhood String
  addressCity         String
  addressState        String
  addressZipCode      String
  status              AppointmentStatus @default(SCHEDULED)
  assignedToId        String?
  notes               String?
  completionNotes     String?
  reminderSentAt      DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  completedAt         DateTime?
  assignedTo          User?             @relation("AssignedTo", fields: [assignedToId], references: [id])
  order               Order?            @relation(fields: [orderId], references: [id])
  quote               Quote?            @relation(fields: [quoteId], references: [id])
  user                User              @relation(fields: [userId], references: [id])

  @@map("appointments")
}

model Document {
  id           String         @id @default(uuid())
  userId       String
  orderId      String?
  quoteId      String?
  type         DocumentType
  name         String
  url          String
  mimeType     String
  size         Int
  status       DocumentStatus @default(PENDING)
  signedAt     DateTime?
  signedBy     String?
  signatureUrl String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  order        Order?         @relation(fields: [orderId], references: [id])
  quote        Quote?         @relation(fields: [quoteId], references: [id])
  user         User           @relation(fields: [userId], references: [id])

  @@map("documents")
}

model Conversation {
  id            String             @id @default(uuid())
  userId        String?
  phoneNumber   String
  customerName  String?
  status        ConversationStatus @default(ACTIVE)
  assignedToId  String?
  context       Json?
  quoteId       String?
  appointmentId String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  lastMessageAt DateTime           @default(now())
  assignedTo    User?              @relation("AssignedConversations", fields: [assignedToId], references: [id])
  quote         Quote?             @relation(fields: [quoteId], references: [id])
  user          User?              @relation(fields: [userId], references: [id])
  messages      Message[]

  @@map("conversations")
}

model Message {
  id             String           @id @default(uuid())
  conversationId String
  direction      MessageDirection
  type           MessageType
  content        String
  mediaUrl       String?
  senderType     SenderType
  senderId       String?
  status         MessageStatus?
  createdAt      DateTime         @default(now())
  conversation   Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User?            @relation(fields: [senderId], references: [id])

  @@map("messages")
}

model AiConversation {
  id            String      @id @default(uuid())
  sessionId     String      @unique
  customerName  String?
  customerEmail String?
  customerPhone String?
  quoteContext  Json?
  quoteId       String?     @unique
  status        String      @default("ACTIVE")
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastMessageAt DateTime    @default(now())
  quote         Quote?      @relation(fields: [quoteId], references: [id])
  messages      AiMessage[]

  @@index([sessionId])
  @@index([quoteId])
  @@map("ai_conversations")
}

model AiMessage {
  id             String         @id @default(uuid())
  conversationId String
  role           String
  content        String
  metadata       Json?
  imageUrl       String?
  createdAt      DateTime       @default(now())
  conversation   AiConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("ai_messages")
}

model Supplier {
  id                  String          @id @default(uuid())
  name                String
  tradeName           String?
  cnpj                String?         @unique
  email               String          @unique
  phone               String?
  whatsapp            String?
  street              String?
  number              String?
  complement          String?
  neighborhood        String?
  city                String?
  state               String?
  zipCode             String?
  categories          String[]
  rating              Decimal?
  totalQuotes         Int             @default(0)
  totalOrders         Int             @default(0)
  isActive            Boolean         @default(true)
  isPreferred         Boolean         @default(false)
  notes               String?
  averageDeliveryDays Int?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  orders              Order[]
  selectedQuotes      Quote[]         @relation("SelectedSupplier")
  supplierQuotes      SupplierQuote[]

  @@map("suppliers")
}

model SupplierQuote {
  id              String              @id @default(uuid())
  quoteId         String
  supplierId      String
  status          SupplierQuoteStatus @default(PENDING)
  subtotal        Decimal?
  shippingFee     Decimal             @default(0)
  laborFee        Decimal             @default(0)
  materialFee     Decimal             @default(0)
  total           Decimal?
  deliveryDays    Int?
  supplierNotes   String?
  internalNotes   String?
  emailSentAt     DateTime?
  respondedAt     DateTime?
  parseConfidence String?
  rawResponse     String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  quote           Quote               @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  supplier        Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([quoteId, supplierId])
  @@map("supplier_quotes")
}

enum Role {
  CUSTOMER
  ADMIN
  STAFF
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

enum ProductCategory {
  BOX
  ESPELHOS
  VIDROS
  PORTAS
  JANELAS
  GUARDA_CORPO
  CORTINAS_VIDRO
  PERGOLADOS
  TAMPOS_PRATELEIRAS
  DIVISORIAS
  FECHAMENTOS
  FERRAGENS
  KITS
  SERVICOS
  OUTROS
  FACHADAS
  PAINEIS_DECORATIVOS
}

enum PriceType {
  FIXED
  PER_M2
  QUOTE_ONLY
}

enum QuoteStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

enum QuoteSource {
  WEBSITE
  WHATSAPP
  PHONE
  WALKIN
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  BOLETO
  CASH
}

enum OrderStatus {
  ORCAMENTO_ENVIADO
  AGUARDANDO_PAGAMENTO
  APROVADO
  EM_PRODUCAO
  PRONTO_ENTREGA
  INSTALACAO_AGENDADA
  INSTALANDO
  CONCLUIDO
  CANCELADO
  AGUARDANDO_CLIENTE
  EM_REVISAO
}

enum OrderItemStatus {
  PENDING
  IN_PRODUCTION
  READY
  INSTALLED
}

enum AppointmentType {
  VISITA_TECNICA
  INSTALACAO
  MANUTENCAO
  REVISAO
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
  NO_SHOW
}

enum DocumentType {
  CONTRATO
  GARANTIA
  NOTA_FISCAL
  ORCAMENTO_PDF
  FOTO
  OUTRO
}

enum DocumentStatus {
  PENDING
  SIGNED
  ACTIVE
  EXPIRED
}

enum ConversationStatus {
  ACTIVE
  WAITING_HUMAN
  CLOSED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  AUDIO
  LOCATION
}

enum SenderType {
  CUSTOMER
  AI
  HUMAN
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

enum SupplierQuoteStatus {
  PENDING
  RESPONDED
  SELECTED
  REJECTED
}

// In-app notifications
model Notification {
  id          String             @id @default(uuid())
  userId      String
  type        NotificationType
  title       String
  message     String
  link        String?
  isRead      Boolean            @default(false)
  createdAt   DateTime           @default(now())
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

enum NotificationType {
  QUOTE_RECEIVED
  QUOTE_ACCEPTED
  QUOTE_REJECTED
  ORDER_STATUS_CHANGED
  PAYMENT_RECEIVED
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMED
  NEW_MESSAGE
  SYSTEM
}
