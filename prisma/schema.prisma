// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====================
// AUTH & USERS
// ====================

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String?
  name     String
  phone    String?
  cpfCnpj  String?

  // Endereço principal
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  zipCode      String?

  // Auth
  role          Role         @default(CUSTOMER)
  emailVerified DateTime?
  phoneVerified Boolean      @default(false)
  authProvider  AuthProvider @default(EMAIL)
  googleId      String?      @unique

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relações
  accounts              Account[]
  sessions              Session[]
  orders                Order[]
  quotes                Quote[]
  appointments          Appointment[]
  documents             Document[]
  conversations         Conversation[]
  messages              Message[]
  assignedAppointments  Appointment[]  @relation("AssignedTo")
  assignedConversations Conversation[] @relation("AssignedConversations")

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum Role {
  CUSTOMER
  ADMIN
  STAFF
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

// ====================
// PRODUCTS
// ====================

model Product {
  id String @id @default(uuid())

  // Básico
  name             String
  slug             String  @unique
  description      String
  shortDescription String?

  // Categorização
  category    ProductCategory
  subcategory String?

  // Mídia
  images    String[]
  thumbnail String?

  // Preço
  priceType     PriceType
  basePrice     Decimal?
  pricePerM2    Decimal?
  priceRangeMin Decimal?
  priceRangeMax Decimal?

  // Opções
  colors      String[]
  finishes    String[]
  thicknesses String[]

  // Status
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // SEO
  metaTitle       String?
  metaDescription String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  quoteItems QuoteItem[]
  orderItems OrderItem[]

  @@map("products")
}

enum ProductCategory {
  BOX
  ESPELHOS
  VIDROS
  PORTAS
  JANELAS
  GUARDA_CORPO
  CORTINAS_VIDRO
  PERGOLADOS
  TAMPOS_PRATELEIRAS
  DIVISORIAS
  FECHAMENTOS
  FERRAGENS
  KITS
  SERVICOS
  OUTROS
}

enum PriceType {
  FIXED
  PER_M2
  QUOTE_ONLY
}

// ====================
// QUOTES
// ====================

model Quote {
  id     String @id @default(uuid())
  number String @unique

  // Cliente
  userId        String
  customerName  String
  customerEmail String
  customerPhone String

  // Endereço do serviço
  serviceStreet       String
  serviceNumber       String
  serviceComplement   String?
  serviceNeighborhood String
  serviceCity         String
  serviceState        String
  serviceZipCode      String

  // Valores
  subtotal Decimal
  discount Decimal @default(0)
  total    Decimal

  // Status
  status QuoteStatus @default(DRAFT)

  // Validade
  validUntil DateTime

  // Notas
  internalNotes String?
  customerNotes String?

  // Origem
  source QuoteSource

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  sentAt     DateTime?
  viewedAt   DateTime?
  acceptedAt DateTime?

  // Fornecedor selecionado
  selectedSupplierId String?
  selectedSupplier   Supplier? @relation("SelectedSupplier", fields: [selectedSupplierId], references: [id])

  // Relações
  user           User            @relation(fields: [userId], references: [id])
  items          QuoteItem[]
  orders         Order[]
  conversations  Conversation[]
  appointments   Appointment[]
  documents      Document[]
  aiConversation AiConversation?
  supplierQuotes SupplierQuote[]

  @@map("quotes")
}

model QuoteItem {
  id        String  @id @default(uuid())
  quoteId   String
  productId String?

  // Descrição
  description    String
  specifications String?

  // Medidas
  width    Decimal?
  height   Decimal?
  quantity Int      @default(1)

  // Opções
  color      String?
  finish     String?
  thickness  String?
  glassType  String?
  glassColor String?
  model      String?

  // Valores
  unitPrice  Decimal
  totalPrice Decimal

  // Imagens do cliente
  customerImages String[]

  // Relações
  quote   Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@map("quote_items")
}

enum QuoteStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

enum QuoteSource {
  WEBSITE
  WHATSAPP
  PHONE
  WALKIN
}

// ====================
// ORDERS
// ====================

model Order {
  id     String @id @default(uuid())
  number String @unique

  // Origem
  quoteId    String?
  supplierId String?

  // Cliente
  userId String

  // Endereço
  serviceStreet       String
  serviceNumber       String
  serviceComplement   String?
  serviceNeighborhood String
  serviceCity         String
  serviceState        String
  serviceZipCode      String

  // Valores
  subtotal        Decimal
  discount        Decimal @default(0)
  installationFee Decimal @default(0)
  total           Decimal

  // Pagamento
  paymentStatus         PaymentStatus  @default(PENDING)
  paymentMethod         PaymentMethod?
  paidAmount            Decimal        @default(0)
  stripeSessionId       String?
  stripePaymentIntentId String?

  // Status
  status OrderStatus @default(ORCAMENTO_ENVIADO)

  // Datas
  estimatedDelivery DateTime?
  installedAt       DateTime?
  completedAt       DateTime?

  // Garantia
  warrantyUntil DateTime?

  // Notas
  internalNotes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  user         User                 @relation(fields: [userId], references: [id])
  quote        Quote?               @relation(fields: [quoteId], references: [id])
  supplier     Supplier?            @relation(fields: [supplierId], references: [id])
  items        OrderItem[]
  timeline     OrderTimelineEntry[]
  appointments Appointment[]
  documents    Document[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  productId String?

  description    String
  specifications String?

  width    Decimal?
  height   Decimal?
  quantity Int      @default(1)

  color     String?
  finish    String?
  thickness String?

  unitPrice  Decimal
  totalPrice Decimal

  status OrderItemStatus @default(PENDING)

  // Relações
  order   Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model OrderTimelineEntry {
  id      String @id @default(uuid())
  orderId String

  status      String
  description String
  createdBy   String // userId ou 'system'
  createdAt   DateTime @default(now())

  // Relações
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_timeline")
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  BOLETO
  CASH
}

enum OrderStatus {
  ORCAMENTO_ENVIADO
  AGUARDANDO_PAGAMENTO
  APROVADO
  EM_PRODUCAO
  PRONTO_ENTREGA
  INSTALACAO_AGENDADA
  INSTALANDO
  CONCLUIDO
  CANCELADO
  AGUARDANDO_CLIENTE
  EM_REVISAO
}

enum OrderItemStatus {
  PENDING
  IN_PRODUCTION
  READY
  INSTALLED
}

// ====================
// APPOINTMENTS
// ====================

model Appointment {
  id String @id @default(uuid())

  // Referência
  userId  String
  orderId String?
  quoteId String?

  // Tipo
  type AppointmentType

  // Data/Hora
  scheduledDate     DateTime
  scheduledTime     String // HH:MM format
  estimatedDuration Int // minutos

  // Endereço
  addressStreet       String
  addressNumber       String
  addressComplement   String?
  addressNeighborhood String
  addressCity         String
  addressState        String
  addressZipCode      String

  // Status
  status AppointmentStatus @default(SCHEDULED)

  // Técnico
  assignedToId String?

  // Notas
  notes           String?
  completionNotes String?

  // Lembretes
  reminderSentAt DateTime?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relações
  user       User   @relation(fields: [userId], references: [id])
  order      Order? @relation(fields: [orderId], references: [id])
  quote      Quote? @relation(fields: [quoteId], references: [id])
  assignedTo User?  @relation("AssignedTo", fields: [assignedToId], references: [id])

  @@map("appointments")
}

enum AppointmentType {
  VISITA_TECNICA
  INSTALACAO
  MANUTENCAO
  REVISAO
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
  NO_SHOW
}

// ====================
// DOCUMENTS
// ====================

model Document {
  id String @id @default(uuid())

  // Referência
  userId  String
  orderId String?
  quoteId String?

  // Tipo
  type DocumentType

  // Arquivo
  name     String
  url      String
  mimeType String
  size     Int // bytes

  // Status
  status DocumentStatus @default(PENDING)

  // Assinatura
  signedAt     DateTime?
  signedBy     String?
  signatureUrl String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  user  User   @relation(fields: [userId], references: [id])
  order Order? @relation(fields: [orderId], references: [id])
  quote Quote? @relation(fields: [quoteId], references: [id])

  @@map("documents")
}

enum DocumentType {
  CONTRATO
  GARANTIA
  NOTA_FISCAL
  ORCAMENTO_PDF
  FOTO
  OUTRO
}

enum DocumentStatus {
  PENDING
  SIGNED
  ACTIVE
  EXPIRED
}

// ====================
// WHATSAPP
// ====================

model Conversation {
  id String @id @default(uuid())

  // Cliente
  userId       String?
  phoneNumber  String
  customerName String?

  // Status
  status       ConversationStatus @default(ACTIVE)
  assignedToId String?

  // Contexto (JSON)
  context Json?

  // Resultado
  quoteId       String?
  appointmentId String?

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastMessageAt DateTime @default(now())

  // Relações
  user       User?     @relation(fields: [userId], references: [id])
  assignedTo User?     @relation("AssignedConversations", fields: [assignedToId], references: [id])
  quote      Quote?    @relation(fields: [quoteId], references: [id])
  messages   Message[]

  @@map("conversations")
}

model Message {
  id             String @id @default(uuid())
  conversationId String

  // Direção
  direction MessageDirection

  // Conteúdo
  type     MessageType
  content  String
  mediaUrl String?

  // Remetente
  senderType SenderType
  senderId   String?

  // Status (outbound)
  status MessageStatus?

  // Timestamps
  createdAt DateTime @default(now())

  // Relações
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User?        @relation(fields: [senderId], references: [id])

  @@map("messages")
}

// ====================
// AI CONVERSATIONS (Website Chat)
// ====================

model AiConversation {
  id String @id @default(uuid())

  // Session
  sessionId String @unique

  // Customer Info
  customerName  String?
  customerEmail String?
  customerPhone String?

  // Context
  quoteContext Json? // Armazena dados do orçamento em progresso

  // Vinculação com Quote
  quoteId String? @unique

  // Status
  status String @default("ACTIVE") // ACTIVE, CONVERTED, CLOSED

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastMessageAt DateTime @default(now())

  // Relações
  quote    Quote?      @relation(fields: [quoteId], references: [id])
  messages AiMessage[]

  @@index([sessionId])
  @@index([quoteId])
  @@map("ai_conversations")
}

model AiMessage {
  id             String @id @default(uuid())
  conversationId String

  // Message
  role    String // "user" | "assistant" | "system"
  content String @db.Text

  // Metadados
  metadata Json? // Informações extras (produto sugerido, etc)
  imageUrl String? // URL da imagem se houver

  // Timestamps
  createdAt DateTime @default(now())

  // Relações
  conversation AiConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("ai_messages")
}

enum ConversationStatus {
  ACTIVE
  WAITING_HUMAN
  CLOSED
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  AUDIO
  LOCATION
}

enum SenderType {
  CUSTOMER
  AI
  HUMAN
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

// ====================
// SUPPLIERS (FORNECEDORES)
// ====================

model Supplier {
  id String @id @default(uuid())

  // Informações básicas
  name      String
  tradeName String? // Nome fantasia
  cnpj      String? @unique

  // Contato
  email    String  @unique
  phone    String?
  whatsapp String?

  // Endereço
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?
  zipCode      String?

  // Categorias que fornece
  categories String[] // ["BOX", "ESPELHOS", "VIDROS"]

  // Avaliação
  rating      Decimal? // 0-5 estrelas
  totalQuotes Int      @default(0)
  totalOrders Int      @default(0)

  // Status
  isActive    Boolean @default(true)
  isPreferred Boolean @default(false) // Fornecedor preferencial

  // Notas internas
  notes String?

  // Prazos típicos
  averageDeliveryDays Int?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  supplierQuotes SupplierQuote[]
  orders         Order[]
  selectedQuotes Quote[]         @relation("SelectedSupplier")

  @@map("suppliers")
}

model SupplierQuote {
  id String @id @default(uuid())

  // Referências
  quoteId    String
  supplierId String

  // Status
  status SupplierQuoteStatus @default(PENDING)

  // Valores fornecidos
  subtotal    Decimal?
  shippingFee Decimal  @default(0)
  laborFee    Decimal  @default(0)
  materialFee Decimal  @default(0)
  total       Decimal?

  // Prazo
  deliveryDays Int?

  // Notas
  supplierNotes String? // O que o fornecedor respondeu
  internalNotes String? // Notas internas do admin

  // Email enviado
  emailSentAt DateTime?

  // Resposta recebida
  respondedAt DateTime?

  // Confiança do parsing automático
  parseConfidence String? // "HIGH", "MEDIUM", "LOW"
  rawResponse     String? // Texto original da resposta

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  quote    Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([quoteId, supplierId])
  @@map("supplier_quotes")
}

enum SupplierQuoteStatus {
  PENDING // Enviado, aguardando resposta
  RESPONDED // Fornecedor respondeu
  SELECTED // Este fornecedor foi escolhido
  REJECTED // Orçamento rejeitado pelo admin
}
